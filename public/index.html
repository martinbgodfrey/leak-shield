<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepScan // Investigator</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #e2e8f0; --accent: #38bdf8; --green: #22c55e; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* TOP PANEL (NEW) */
        .evidence-panel { 
            background: #1e293b; border: 1px solid #38bdf8; border-radius: 8px; padding: 20px; 
            margin-bottom: 20px; display: none; align-items: center; gap: 20px; box-shadow: 0 0 20px rgba(56, 189, 248, 0.2);
        }
        .evidence-thumb { width: 150px; height: 100px; object-fit: cover; border: 1px solid #fff; }
        .evidence-info { flex: 1; }
        
        /* CONTROLS */
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 4px; }
        button { padding: 12px 20px; cursor: pointer; border-radius: 4px; font-weight: bold; border: none; }
        #scanBtn { background: var(--accent); color: black; }
        
        /* RESULTS LIST */
        .card { background: #1e293b; padding: 15px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #334155; }
        .card.fresh { border-left-color: var(--accent); }
        .btn-capture { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        .btn-capture:hover { background: rgba(56, 189, 248, 0.1); }
        .btn-loading { cursor: not-allowed; opacity: 0.5; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; z-index: 999; }
        .modal img { max-width: 90%; max-height: 80vh; border: 2px solid #fff; }
        .modal-controls { position: absolute; bottom: 30px; display: flex; gap: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>DEEPSCAN // DASHBOARD</h1>

        <div id="evidencePanel" class="evidence-panel">
            <img id="latestThumb" class="evidence-thumb" src="">
            <div class="evidence-info">
                <h3 style="margin:0; color: var(--accent);">CAPTURE SUCCESSFUL</h3>
                <p id="latestFilename" style="font-size: 0.9rem; color: #94a3b8; margin: 5px 0;">Filename...</p>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button onclick="openModalFromPanel()" style="background:var(--green); color:black;">üëÅÔ∏è VIEW FULLSCREEN</button>
                    <a id="latestDL" href="#" download><button style="background:#334155; color:white;">‚¨áÔ∏è DOWNLOAD</button></a>
                </div>
            </div>
        </div>

        <div class="controls">
            <input type="text" id="keywords" value="alexis texas" placeholder="Enter keywords...">
            <button id="scanBtn" onclick="runScan()">SCAN NETWORKS</button>
        </div>

        <div id="results"></div>
    </div>

    <div id="modal" class="modal" onclick="closeModal(event)">
        <div style="display:flex; flex-direction:column; align-items:center;">
            <img id="modalImg" src="">
            <div class="modal-controls">
                <button onclick="document.getElementById('modal').style.display='none'">CLOSE</button>
            </div>
        </div>
    </div>

    <script>
        // GLOBAL STATE FOR LATEST CAPTURE
        let currentEvidence = { img: null, filename: null };

        async function runScan() {
            const btn = document.getElementById('scanBtn');
            const list = document.getElementById('results');
            btn.disabled = true; btn.innerText = "SCANNING...";
            list.innerHTML = "<div style='text-align:center; padding:20px'>Scanning...</div>";

            try {
                const res = await fetch('/scan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ keywords: document.getElementById('keywords').value.split(',') })
                });
                const data = await res.json();
                
                list.innerHTML = "";
                data.data.forEach(item => {
                    const isFresh = item.date.includes('hour') || item.date.includes('day') || item.date.includes('min');
                    list.innerHTML += `
                        <div class="card ${isFresh ? 'fresh' : ''}">
                            <div style="flex:1">
                                <div style="font-weight:bold; color: ${isFresh ? '#38bdf8' : 'white'}">${item.title}</div>
                                <div style="font-size:0.8rem; color:#94a3b8;">${item.source} ‚Ä¢ ${item.date}</div>
                                <div style="font-size:0.7rem; color:#64748b;">${item.url}</div>
                            </div>
                            <button class="btn-capture" onclick="capture(this, '${item.url}', '${item.source}')">üì∏ CAPTURE</button>
                        </div>
                    `;
                });
            } catch (e) { list.innerHTML = "Error: " + e.message; }
            btn.disabled = false; btn.innerText = "SCAN NETWORKS";
        }

        async function capture(btn, url, source) {
            // UI RESET
            const originalText = btn.innerText;
            btn.innerText = "‚è≥...";
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const res = await fetch('/capture', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url, source })
                });
                const data = await res.json();

                if (data.success) {
                    btn.innerText = "‚úÖ DONE";
                    
                    // UPDATE TOP PANEL (Fixes "One Button" Issue)
                    currentEvidence.img = data.image;
                    currentEvidence.filename = data.filename;
                    
                    document.getElementById('latestThumb').src = data.image;
                    document.getElementById('latestFilename').innerText = data.filename;
                    document.getElementById('latestDL').href = data.image;
                    document.getElementById('latestDL').download = data.filename;
                    
                    // Show Panel
                    document.getElementById('evidencePanel').style.display = 'flex';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    throw new Error(data.error);
                }
            } catch (e) {
                btn.innerText = "‚ùå FAIL";
                alert("Capture Failed: " + e.message);
            } finally {
                // Always re-enable button after 3 seconds so they can try again if needed
                setTimeout(() => {
                    btn.disabled = false;
                    btn.classList.remove('btn-loading');
                    btn.innerText = "üì∏ CAPTURE";
                }, 3000);
            }
        }

        function openModalFromPanel() {
            if(!currentEvidence.img) return;
            document.getElementById('modalImg').src = currentEvidence.img;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal(e) {
            if(e.target.id === 'modal') document.getElementById('modal').style.display = 'none';
        }
    </script>
</body>
</html>
