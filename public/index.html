<script>
    let allData = [];
    let currentEvidence = {};

    // 1. ENTER KEY LISTENER (Search)
    document.getElementById('keywords').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            runScan();
        }
    });

    // 2. ESC KEY LISTENER (Close Modal)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.getElementById('modal').style.display = 'none';
        }
    });

    async function runScan() {
        const btn = document.getElementById('scanBtn');
        const list = document.getElementById('results');
        
        btn.disabled = true; 
        btn.innerText = "SCANNING...";
        list.innerHTML = "<div style='text-align:center; padding:40px; color:#94a3b8;'>Scanning networks... (This may take 30s)</div>";

        try {
            const res = await fetch('/scan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ keywords: document.getElementById('keywords').value.split(',') })
            });
            const data = await res.json();
            allData = data.data || [];
            
            // Setup Filters (Updated to be hidden initially)
            document.getElementById('filterBar').style.display = 'flex';
            generateSourceButtons(allData);
            applyFilters();

        } catch (e) {
            list.innerHTML = `<div style="color:red; text-align:center;">Error: ${e.message}</div>`;
        }
        btn.disabled = false; 
        btn.innerText = "SCAN NETWORKS";
    }

    // ... (Keep existing generateSourceButtons, setDateFilter, etc.) ...
    
    // ... (Keep existing capture() function) ...

    function openModalFromPanel() {
        if(!currentEvidence.img) return;
        document.getElementById('modalImg').src = currentEvidence.img;
        document.getElementById('modal').style.display = 'flex';
    }
    
    // Close modal on click outside image
    function closeModal(e) { 
        if(e.target.id === 'modal') document.getElementById('modal').style.display = 'none'; 
    }
    
    // ... (Rest of existing render logic) ...
</script>